<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Trip report</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-secondary-bg-color, #0f1220);
      --text: var(--tg-theme-text-color, #e6e6e6);
      --muted: var(--tg-theme-hint-color, #9aa3b2);
      --accent: var(--tg-theme-button-color, #4e8cff);
      --accentText: var(--tg-theme-button-text-color, #fff);
      --card: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 18px;
      --err:#f43f5e;

      --primary: var(--accent);
      --primary-600: var(--accent);
    }

    *{ box-sizing:border-box; -webkit-tap-highlight-color: transparent; }
    html,body{ height:100%; }

    /* --- ИСПРАВЛЕННЫЙ BODY (как в index.html) --- */
    body{
      margin:0;
      color:var(--text);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(78,140,255,0.25), transparent 60%),
        radial-gradient(1000px 500px at -10% 110%, rgba(168,85,247,0.20), transparent 60%),
        var(--bg);

      /* Авто-выравнивание */
      display: grid;
      place-items: center;
      min-height: 100vh;
      padding: 16px;
    }

    /* УБРАН Topbar */

    /* .wrap - это теперь наша главная обертка, которую центрирует body */
    .wrap{ 
        max-width:520px; /* Стандартная ширина карточки */
        width: 100%;
        margin:0 auto; 
    }

    /* .section - это стиль карточки */
    .section{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
      padding: 18px;
      margin-bottom: 14px;
    }
    .title{ font-weight:700; font-size:18px; margin:0 0 6px }
    .hint{ color:var(--muted); margin:0 0 12px; font-size: 13px; }

    .grid{ display:grid; gap:12px }
    .grid-2{ grid-template-columns:1fr 1fr }

    /* .card - это стиль для поля ввода, переименуем, чтобы не путать */
    .field-card{
      background: rgba(255,255,255,0.05);
      border:1px solid var(--stroke);
      border-radius:14px; padding:14px;
    }
    label{ display:block; margin:4px 2px 6px 2px; color:var(--muted); font-size:13px }
    input{
      width:100%; border:1px solid var(--stroke); color:var(--text);
      background: rgba(255,255,255,0.04);
      border-radius:14px; padding:14px 14px; font-size:16px; outline:none;
    }
    input:focus {
        border-color: var(--accent);
        box-shadow: 0 0 0 2px rgba(78,140,255,.3);
    }
    input[type="date"]{ appearance:none; -webkit-appearance:none }

    .btn{
      background: var(--accent); color: var(--accentText);
      border:none; border-radius:14px; padding:14px 18px; font-weight:800; cursor:pointer;
      transition: transform .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .ghost{
      background:transparent; border:1px solid var(--stroke); color:var(--text); font-weight:700;
    }
    .btn[disabled]{ opacity:.6; pointer-events:none; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px }
    .chip{
      background: rgba(255,255,255,0.05);
      border:1px solid var(--stroke);
      color: var(--text);
      border-radius:999px; padding:8px 12px; font-weight:700; cursor:pointer;
    }
    .chip.active{ background:linear-gradient(135deg, rgba(78,140,255,.15), rgba(124,58,237,.18)); border-color: var(--stroke); }

    .row{ display:flex; gap:12px }
    .footer{ display:flex; gap:12px; justify-content:space-between; margin-top:16px; flex-wrap: wrap;}

    .err{ color:var(--err); margin:6px 2px 0 2px; font-size:14px }
    [hidden]{ display:none !important }

    .review-block{ margin-top:12px }
    .rv-title{ font-weight:700; margin:6px 0 8px }
    .kv{
      border:1px solid var(--stroke);
      background: rgba(255,255,255,0.04);
      border-radius:14px; overflow:hidden
    }
    .kv-row{ display:flex; gap:12px; padding:10px 12px; border-top:1px solid var(--stroke) }
    .kv-row:first-child{ border-top:none }
    .kv-k{ min-width:140px; color:var(--muted); font-size: 14px; }
    .kv-v { word-break: break-word; }

    .banner{
      margin:10px 0; padding:10px 12px; border-radius:14px;
      border:1px solid var(--stroke); background: rgba(255,255,255,0.04);
      color: var(--text); font-size:14px;
    }
    .banner.error{ border-color: rgba(255,0,0,.35); color:#ff6b6b; }

    @keyframes shake {
      0%{ transform: translateX(0) } 20%{ transform: translateX(-4px) } 40%{ transform: translateX(4px) }
      60%{ transform: translateX(-3px) } 80%{ transform: translateX(3px) } 100%{ transform: translateX(0) }
    }
    .shake { animation: shake .35s ease; }
    .outline-err { box-shadow: 0 0 0 2px rgba(244,63,94,.5); border-color: var(--err); }
  </style>
</head>
<body>
  <div class="wrap">

    <div id="guardError" class="banner error" hidden></div>

    <section id="step_trip" class="section" aria-live="polite">
      <div class="title">Trip report</div>
      <p class="hint">Fill out trip, loads and expenses. Your Telegram ID will be captured automatically.</p>

      <div id="trip_banner" class="banner error" hidden></div>

      <div class="grid">
        <div class="field-card">
          <label for="start_location">Start location</label>
          <input id="start_location" placeholder="City, ST">
        </div>
        <div class="grid grid-2">
          <div class="field-card">
            <label for="start_date">Start date</label>
            <input id="start_date" type="date">
          </div>
          <div class="field-card">
            <label for="start_mileage">Start mileage</label>
            <input id="start_mileage" inputmode="numeric" placeholder="e.g., 102345">
          </div>
        </div>
        <div class="field-card">
          <label for="finish_location">Finish location</label>
          <input id="finish_location" placeholder="City, ST">
        </div>
        <div class="grid grid-2">
          <div class="field-card">
            <label for="finish_date">Finish date</label>
            <input id="finish_date" type="date">
          </div>
          <div class="field-card">
            <label for="finish_mileage">Finish mileage</label>
            <input id="finish_mileage" inputmode="numeric" placeholder="e.g., 103210">
          </div>
        </div>
        <div id="trip_err" class="err" hidden></div>
      </div>

      <div class="footer">
        <button class="btn ghost" type="button" onclick="backToMenu()">Back to Menu</button>
        <button class="btn" type="button" onclick="goStep('loads')">Next → Loads</button>
      </div>
    </section>

    <section id="step_loads" class="section" aria-live="polite" hidden>
      <div class="title">Loads</div>
      <p class="hint">Add one or more loads. Partial/Tarp are quantities (can be 0 or empty).</p>

      <div id="loads_banner" class="banner error" hidden></div>

      <div id="loadChips" class="chips"></div>
      <div id="loadCard" class="field-card"></div>
      <div id="loads_err" class="err" hidden></div>

      <div class="footer">
        <div class="row">
          <button class="btn ghost" type="button" onclick="addLoad()">+ Add load</button>
          <button class="btn ghost" type="button" onclick="removeCurrentLoad()">Remove</button>
        </div>
        <div class="row">
          <button class="btn ghost" type="button" onclick="goStep('trip')">← Back</button>
          <button class="btn" type="button" onclick="goStep('expenses')">Next →</button>
        </div>
      </div>
    </section>

    <section id="step_expenses" class="section" aria-live="polite" hidden>
      <div class="title">Expenses</div>
      <p class="hint">Optional. Add fuel, parking, wash, etc.</p>

      <div id="expenses_banner" class="banner error" hidden></div>

      <div id="expList" class="grid"></div>
      <div class="row" style="margin-top:12px;">
        <button class="btn" type="button" onclick="addExpense()">+ Add expense</button>
      </div>

      <div class="footer">
        <button class="btn ghost" type="button" onclick="goStep('loads')">← Back</button>
        <button class="btn" type="button" onclick="goStep('review')">Next → Review</button>
      </div>
    </section>

    <section id="step_review" class="section" aria-live="polite" hidden>
      <div class="title">Review & submit</div>

      <div id="review_banner" class="banner error" hidden></div>

      <div id="reviewBox" class="review-block"></div>

      <div id="submit_err" class="err" hidden></div>

      <div class="footer">
        <button class="btn ghost" type="button" onclick="goStep('expenses')">← Back</button>
        <button id="submitBtn" class="btn" type="button" onclick="submitTrip()">Submit</button>
      </div>
    </section>

  </div>

<script>
/* ---------- Telegram init ---------- */
const tg = window.Telegram?.WebApp;
if (tg){ tg.ready(); tg.expand(); tg.MainButton.hide(); }

/* ---------- API guard ---------- */
const API_BASE = 'https://eyeubidvqegcrseedlyz.supabase.co/functions/v1';
const ME_URL   = `${API_BASE}/rapid-function`;
const REG_URL  = `${API_BASE}/clever-action`;
const KEY_ME   = 'me:v1';

function getUserId(){ return tg?.initDataUnsafe?.user?.id ?? null; }
function readCache(){ try{ return JSON.parse(sessionStorage.getItem(KEY_ME) || 'null'); }catch{ return null; } }
function writeCache(obj){ try{ sessionStorage.setItem(KEY_ME, JSON.stringify(obj)); }catch{} }

async function fetchMe(){
  const res = await fetch(ME_URL, {
    method:'POST',
    headers:{
      'content-type':'application/json',
      'x-telegram-init-data': tg?.initData || ''
    },
    body: JSON.stringify({_tg_meta:{initData: tg?.initData||'', user: tg?.initDataUnsafe?.user||null}})
  });
  if(!res.ok) throw new Error('Network error');
  return await res.json();
}
async function ensureRegistered(){
  const uid = getUserId();
  const cached = readCache();
  if (cached && cached.userId === uid && cached.registered) return cached;

  const data = await fetchMe();
  const payload = { userId: uid, registered: !!data?.registered, profile: data?.profile || null };
  writeCache(payload);
  if (!payload.registered) {
    location.replace('register.html');
    return null;
  }
  return payload;
}
function showGuardError(msg){
  const el = document.getElementById('guardError');
  el.textContent = msg;
  el.hidden = false;
}

/* ---------- Back routing ---------- */
function backToMenu(){
  try { location.replace('index.html'); }
  catch(e){}
  finally{ setTimeout(()=> tg?.close?.(), 150); }
}

/* ---------- Helpers for UX errors ---------- */
function setBanner(id, msg){
  const el = document.getElementById(id);
  if (!el) return;
  if (!msg){ el.hidden = true; el.textContent=''; return; }
  el.textContent = msg;
  el.hidden = false;
  el.scrollIntoView({ behavior:'smooth', block:'center' });
}

function shake(id){
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('shake');
  void el.offsetWidth; // restart animation
  el.classList.add('shake');
}

function focusElem(id){
  const el = document.getElementById(id);
  if (el && typeof el.focus==='function') el.focus();
}

function outlineError(id, on=true){
  const el = document.getElementById(id);
  if (!el) return;
  const parentCard = el.closest('.field-card'); // Находим родительскую field-card
  if (on) {
      if (parentCard) parentCard.classList.add('outline-err');
      else el.classList.add('outline-err');
  } else {
      if (parentCard) parentCard.classList.remove('outline-err');
      else el.classList.remove('outline-err');
  }
}

/* ---------- Original state/logic (format unchanged) ---------- */
const WEBHOOK_URL = 'https://venture666.app.n8n.cloud/webhook/a20cec7e-fc93-4a5c-b314-935c5009b235';

const state = {
  step: 'trip',
  loads: [],
  currentLoadIndex: 0,
  expenses: [],
};
let inFlight = false;

function goStep(step){
  // Очистка баннеров текущего шага
  if (state.step==='trip')    setBanner('trip_banner', null);
  if (state.step==='loads')   setBanner('loads_banner', null);
  if (state.step==='expenses')setBanner('expenses_banner', null);
  if (state.step==='review')  setBanner('review_banner', null);

  if (step==='loads' && !validateTrip()) return;
  if (step==='expenses'){
    if (!validateLoads()){
      // Подсказываем, что сделать
      setBanner('loads_banner', 'Add at least one load and fill any of its fields (Date, Pickup, Delivery or Partial/Tarp).');
      shake('loadCard');
      return;
    }
  }
  if (step==='review'){
    if (!validateTrip()) return;
    if (!validateLoads()){
      setBanner('loads_banner', 'Add at least one load and fill any of its fields (Date, Pickup, Delivery or Partial/Tarp).');
      state.step='loads';
      document.getElementById('step_trip').hidden = true;
      document.getElementById('step_loads').hidden = false;
      document.getElementById('step_expenses').hidden = true;
      document.getElementById('step_review').hidden = true;
      shake('loadCard');
      return;
    }
    renderReview();
  }

  state.step = step;
  document.getElementById('step_trip').hidden     = step!=='trip';
  document.getElementById('step_loads').hidden    = step!=='loads';
  document.getElementById('step_expenses').hidden = step!=='expenses';
  document.getElementById('step_review').hidden   = step!=='review';
  
  // Скролл к верху новой секции
  const newSection = document.getElementById(`step_${step}`);
  if(newSection) newSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function validateTrip(){
  const startLoc = val('start_location');
  const finishLoc = val('finish_location');
  const startMil = Number(val('start_mileage')||'');
  const finishMil = Number(val('finish_mileage')||'');
  const err = document.getElementById('trip_err');

  // очистим подсветки
  ['start_location','finish_location','start_mileage','finish_mileage'].forEach(id=> outlineError(id,false));

  if (!startLoc || !finishLoc){
    err.textContent='Enter start and finish locations.'; err.hidden=false;
    setBanner('trip_banner', 'Please provide both Start and Finish locations.');
    const focusId = !startLoc ? 'start_location' : 'finish_location';
    outlineError(focusId,true); focusElem(focusId);
    document.getElementById('step_trip').scrollIntoView({behavior:'smooth', block:'start'});
    return false;
  }
  if (Number.isNaN(startMil) || Number.isNaN(finishMil)){
    err.textContent='Mileage must be numbers.'; err.hidden=false;
    setBanner('trip_banner', 'Mileage must be numeric values.');
    const focusId = Number.isNaN(startMil) ? 'start_mileage' : 'finish_mileage';
    outlineError(focusId,true); focusElem(focusId);
    document.getElementById('step_trip').scrollIntoView({behavior:'smooth', block:'start'});
    return false;
  }
   if (finishMil > 0 && finishMil < startMil){ // Проверяем только если finishMil > 0
    err.textContent='Finish mileage must be ≥ start mileage.'; err.hidden=false;
    setBanner('trip_banner', 'Finish mileage must be greater than or equal to Start mileage.');
    outlineError('finish_mileage',true); focusElem('finish_mileage');
    document.getElementById('step_trip').scrollIntoView({behavior:'smooth', block:'start'});
    return false;
  }
  err.hidden=true; setBanner('trip_banner', null);
  return true;
}

function val(id){ return (document.getElementById(id)?.value || '').trim(); }

function addLoad(){
  saveCurrentLoad(); // Сохраняем текущий перед добавлением нового
  state.loads.push({date:'', pickup:'', delivery:'', partial:'', tarp:''});
  state.currentLoadIndex = state.loads.length-1;
  renderLoads();
}
function removeCurrentLoad(){
  if (!state.loads.length) return;
  state.loads.splice(state.currentLoadIndex,1);
  if (state.currentLoadIndex >= state.loads.length) state.currentLoadIndex = Math.max(0, state.loads.length-1);
  renderLoads();
}
function saveCurrentLoad(){
  const i = state.currentLoadIndex;
  if (state.loads[i]){
    const card = document.getElementById('loadCard');
    const q = (name)=> card.querySelector(`[name="${name}"]`);
    state.loads[i].date     = q('date')?.value || '';
    state.loads[i].pickup   = q('pickup')?.value || '';
    state.loads[i].delivery = q('delivery')?.value || '';
    state.loads[i].partial  = q('partial')?.value || '';
    state.loads[i].tarp     = q('tarp')?.value || '';
  }
}
function hasT(s){ return !!(s && String(s).trim()); }
function hasN(s){ const n=Number(s); return !Number.isNaN(n) && s!==''; }
function isLoadFilled(L){
  return hasT(L.pickup)||hasT(L.delivery)||hasT(L.date)||hasN(L.partial)||hasN(L.tarp);
}
function validateLoads(){
  saveCurrentLoad();
  const err=document.getElementById('loads_err');
  // Снимем подстветку
  if (state.loads.length===0){
    err.textContent='Add at least 1 load.'; err.hidden=false;
    setBanner('loads_banner', 'No loads added. Click “+ Add load”, then fill at least one field.');
    document.getElementById('loadCard').scrollIntoView({behavior:'smooth', block:'center'});
    return false;
  }
  if (!state.loads.some(isLoadFilled)){
    err.textContent='Please fill at least one field in any load.'; err.hidden=false;
    setBanner('loads_banner', 'Fill any field of a load: Date, Pickup, Delivery, Partial or Tarp.');
    document.getElementById('loadCard').scrollIntoView({behavior:'smooth', block:'center'});
    shake('loadCard');
    return false;
  }
  err.hidden=true; setBanner('loads_banner', null);
  return true;
}
function renderLoads(){
  if (state.loads.length===0) state.loads=[{date:'',pickup:'',delivery:'',partial:'',tarp:''}];
  const chips=document.getElementById('loadChips'); chips.innerHTML='';
  state.loads.forEach((_,idx)=>{
    const b=document.createElement('button');
    b.className='chip'+(idx===state.currentLoadIndex?' active':'');
    b.textContent = `Load #${idx+1}`;
    b.onclick=()=>{ saveCurrentLoad(); state.currentLoadIndex=idx; renderLoads(); };
    chips.appendChild(b);
  });

  const i=state.currentLoadIndex, L=state.loads[i]; const card=document.getElementById('loadCard');
  card.innerHTML=`
    <div class="grid">
      <div>
        <label>Date</label>
        <input type="date" name="date" value="${L.date||''}">
      </div>
      <div>
        <label>Pickup location</label>
        <input name="pickup" placeholder="City, ST" value="${esc(L.pickup||'')}">
      </div>
      <div>
        <label>Delivery location</label>
        <input name="delivery" placeholder="City, ST" value="${esc(L.delivery||'')}">
      </div>
      <div class="grid grid-2">
        <div>
          <label>Partial (qty)</label>
          <input name="partial" inputmode="numeric" placeholder="e.g., 1" value="${esc(L.partial||'')}">
        </div>
        <div>
          <label>Tarp (qty)</label>
          <input name="tarp" inputmode="numeric" placeholder="e.g., 2" value="${esc(L.tarp||'')}">
        </div>
      </div>
    </div>
  `;
}

function addExpense(){
  state.expenses.push({ name:'', price:'' });
  renderExpenses();
}
function removeExpense(idx){
  state.expenses.splice(idx,1);
  if (state.expenses.length === 0) { // Если удалили последний, добавляем пустой
      addExpense();
  } else {
      renderExpenses();
  }
}
function renderExpenses(){
  const box=document.getElementById('expList'); box.innerHTML='';
  if (state.expenses.length===0){ state.expenses=[{name:'',price:''}]; }
  state.expenses.forEach((e,idx)=>{
    const row=document.createElement('div'); row.className='field-card'; // Используем field-card
    row.innerHTML = `
      <div class="grid grid-2">
        <div>
          <label>Item</label>
          <input data-i="${idx}" data-k="name" placeholder="Fuel / Parking / Wash" value="${esc(e.name||'')}">
        </div>
        <div>
          <label>Price</label>
          <input inputmode="decimal" data-i="${idx}" data-k="price" placeholder="e.g., 25.50" value="${esc(e.price||'')}">
        </div>
      </div>
      <div class="row" style="margin-top:10px; justify-content: flex-end;">
        <button class="btn ghost" type="button" onclick="removeExpense(${idx})">Remove</button>
      </div>
    `;
    box.appendChild(row);
  });
  box.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', (e)=>{
      const i=Number(e.target.dataset.i), k=e.target.dataset.k;
      if (state.expenses[i]) state.expenses[i][k]=e.target.value;
    });
  });
}

function renderReview(){
  const payload = buildPayload(true);
  const rv = [];

  rv.push(`<div class="rv-title">Trip</div>`);
  rv.push(`<div class="kv">
    ${row('Start location', payload.trip.start_location)}
    ${row('Start date',     payload.trip.start_date||'N/A')}
    ${row('Start mileage',  payload.trip.start_mileage)}
    ${row('Finish location',payload.trip.finish_location)}
    ${row('Finish date',    payload.trip.finish_date||'N/A')}
    ${row('Finish mileage', payload.trip.finish_mileage)}
  </div>`);

  rv.push(`<div class="rv-title" style="margin-top:10px">Loads${payload.loads?.length?` (${payload.loads.length})`:''}</div>`);
  if (payload.loads && payload.loads.length){
    payload.loads.forEach((L,idx)=>{
      const Lrows = [];
      if (L.date)     Lrows.push(row('Date', L.date));
      if (L.pickup)   Lrows.push(row('Pickup', L.pickup));
      if (L.delivery) Lrows.push(row('Delivery', L.delivery));
      if (L.partial!=='' && L.partial!=null) Lrows.push(row('Partial (qty)', L.partial));
      if (L.tarp!=='' && L.tarp!=null)       Lrows.push(row('Tarp (qty)', L.tarp));
      
      if (Lrows.length === 0) Lrows.push(row('Info', 'Empty load skipped'));

      rv.push(`<div class="kv" style="margin-top: 8px;">
        <div class="kv-row"><div class="kv-k" style="color: var(--text);">Load</div><div class="kv-v">#${idx+1}</div></div>
        ${Lrows.join('')}
      </div>`);
    });
  } else {
    rv.push(`<div class="kv"><div class="kv-row"><div class="kv-k">—</div><div class="kv-v">No loads</div></div></div>`);
  }

  const exps = (payload.expenses||[]).filter(e=> (e.name&&e.name.trim()) || (e.price!=='' && !Number.isNaN(Number(e.price))));
  rv.push(`<div class="rv-title" style="margin-top:10px">Expenses${exps.length?` (${exps.length})`:''}</div>`);
  if (exps.length){
    exps.forEach((e,idx)=> rv.push(
      `<div class="kv" style="margin-top: 8px;">
         <div class="kv-row"><div class="kv-k" style="color: var(--text);">Item</div><div class="kv-v">#${idx+1}</div></div>
         ${e.name?row('Name',e.name):''}
         ${e.price!==''?row('Price',e.price):''}
       </div>`
    ));
  } else {
    rv.push(`<div class="kv"><div class="kv-row"><div class="kv-k">—</div><div class="kv-v">No expenses</div></div></div>`);
  }

  document.getElementById('reviewBox').innerHTML = rv.join('');

  function row(k,v){ return `<div class="kv-row"><div class="kv-k">${esc(k)}</div><div class="kv-v">${esc(String(v||''))}</div></div>`; }
}

function buildPayload(){
  saveCurrentLoad();
  // Фильтруем пустые "заполнители"
  const validLoads = state.loads.filter(isLoadFilled).map(L=>({
      date: L.date||'',
      pickup: L.pickup||'',
      delivery: L.delivery||'',
      partial: L.partial,
      tarp: L.tarp
  }));
  const validExpenses = state.expenses.filter(e => (e.name && e.name.trim()) || (e.price !== '' && !Number.isNaN(Number(e.price)))).map(e=>({ name:e.name||'', price:e.price||'' }));

  return {
    trip:{
      start_location: val('start_location'),
      start_date: document.getElementById('start_date')?.value || '',
      start_mileage: Number(val('start_mileage')||'0'),
      finish_location: val('finish_location'),
      finish_date: document.getElementById('finish_date')?.value || '',
      finish_mileage: Number(val('finish_mileage')||'0'),
    },
    loads: validLoads,
    expenses: validExpenses,
    client_token: tg?.initData || '',
    _tg_meta: {
      initData: tg?.initData || '',
      user: tg?.initDataUnsafe?.user || null
    }
  };
}

let lockBtn=false;
function lockSubmit(on){
  const b=document.getElementById('submitBtn');
  if (on){ b.setAttribute('disabled',''); b.textContent='Submitting…'; lockBtn=true; }
  else { b.removeAttribute('disabled'); b.textContent='Submit'; lockBtn=false; }
}
function showSubmitError(msg){ const e=document.getElementById('submit_err'); e.textContent=msg; e.hidden=false; }
function clearSubmitError(){ document.getElementById('submit_err').hidden=true; }
function esc(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

async function submitTrip(){
  if (inFlight) return;
  if (!validateTrip()){ setBanner('review_banner','Fix Trip section first.'); goStep('trip'); return; }
  if (!validateLoads()){ setBanner('review_banner','Add at least one valid Load.'); goStep('loads'); return; }

  const userId = tg?.initDataUnsafe?.user?.id || 'anon';
  const lk = `trip_submit_lock_${userId}`, last = Number(localStorage.getItem(lk)||'0'), now = Date.now();
  if (now-last<120000){ showSubmitError('You have recently submitted a trip. Please try again in a minute.'); return; }

  const payload = buildPayload();
  // Если после фильтрации не осталось грузов, блокируем отправку (еще раз)
  if (payload.loads.length === 0) {
      setBanner('review_banner','Add at least one valid Load.'); 
      goStep('loads');
      return;
  }
  
  clearSubmitError(); lockSubmit(true);
  try{
    const res = await fetch(WEBHOOK_URL,{
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'x-telegram-init-data': tg?.initData || ''
      },
      body:JSON.stringify(payload)
    });
    if (!res.ok){ throw new Error(`HTTP ${res.status}: ${await res.text()}`); }
    localStorage.setItem(lk,String(now));
    if (tg){ 
        tg.showPopup({ title: 'Success', message:'Submitted! Thank you.' }); 
        setTimeout(() => tg.close(), 1500); // Даем пользователю время увидеть
    } else {
        alert('Submitted!');
    }
  }catch(e){ showSubmitError(e.message||'Submit error'); }
  finally{ lockSubmit(false); }
}

/* ---------- init ---------- */
(async ()=>{
  try{
    const me = await ensureRegistered();
    if(!me) return;
  }catch(e){
    showGuardError('Failed to verify registration. Pull to refresh or try again.');
  }

  if (state.loads.length===0) state.loads=[{date:'',pickup:'',delivery:'',partial:'',tarp:''}];
  renderLoads();
  
  if (state.expenses.length===0) state.expenses=[{name:'',price:''}];
  renderExpenses();

  // УБРАН listener для backMenuBtn
})();
</script>
</body>
</html>
