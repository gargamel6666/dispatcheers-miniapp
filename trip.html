<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver • Trip Form</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: var(--tg-theme-secondary-bg-color, #0f1220);
      --text: var(--tg-theme-text-color, #e6e6e6);
      --muted: var(--tg-theme-hint-color, #9aa3b2);
      --accent: var(--tg-theme-button-color, #4e8cff);
      --accentText: var(--tg-theme-button-text-color, #fff);
      --card: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(78,140,255,0.15), transparent 60%), radial-gradient(1000px 700px at 120% 110%, rgba(78,140,255,0.12), transparent 60%), var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    .wrap{min-height:100svh; padding:calc(12px + var(--safe-top)) 16px calc(20px + var(--safe-bottom)); display:flex; flex-direction:column; gap:16px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px); padding:16px}
    h1{font-size:18px;margin:0 0 4px 0}
    .muted{color:var(--muted); font-size:13px}
    label{display:block; font-weight:600; margin:8px 0 6px}
    input[type="text"], input[type="date"], input[type="number"]{width:100%; height:52px; border-radius:14px; border:1px solid var(--stroke); background:rgba(255,255,255,0.04); color:var(--text); padding:0 14px; outline:none}
    .row{display:flex; gap:10px}
    .btn{padding:14px 16px; text-align:center; border-radius:14px; border:0; background:var(--accent); color:var(--accentText); font-weight:700; cursor:pointer}
    .btn.block{display:block; width:100%}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid var(--stroke)}
    .btn[disabled]{opacity:.6; pointer-events:none}
    .tabs{display:flex; gap:6px; flex-wrap:wrap; margin:8px 0}
    .chip{padding:8px 10px; border-radius:12px; border:1px solid var(--stroke); background:rgba(255,255,255,0.05); font-size:13px}
    .error{color:#ff6b6b; font-size:13px; margin-top:8px}
    .ok{color:#2ecc71; font-size:13px; margin-top:8px}
    .hidden{display:none}
    .grid2{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .controls{display:flex; gap:10px; margin-top:10px}
    .sectionTitle{font-weight:800; margin:0 0 8px 0}
    .small{font-size:13px}
    .pair{display:flex; justify-content:space-between; gap:8px; padding:8px 0; border-bottom:1px dashed var(--stroke)}
    .pair:last-child{border-bottom:0}
    .disabled{opacity:0.6; pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Trip Form</h1>
      <div class="muted">Trip → Loads → Expenses → Review → Submit</div>
    </div>

    <!-- Step containers -->
    <div id="step1" class="card">
      <div class="sectionTitle">Step 1 — Trip</div>
      <div class="grid2">
        <div>
          <label>Start location</label>
          <input id="startLoc" type="text" placeholder="City, ST" />
        </div>
        <div>
          <label>Start date</label>
          <input id="startDate" type="date" />
        </div>
        <div>
          <label>Start mileage *</label>
          <input id="startMiles" type="number" inputmode="numeric" placeholder="e.g., 100000" />
        </div>
        <div>
          <label>Finish location</label>
          <input id="finishLoc" type="text" placeholder="City, ST" />
        </div>
        <div>
          <label>Finish date</label>
          <input id="finishDate" type="date" />
        </div>
        <div>
          <label>Finish mileage *</label>
          <input id="finishMiles" type="number" inputmode="numeric" placeholder="e.g., 101235" />
        </div>
      </div>
      <div id="tripErr" class="error hidden"></div>
      <div class="controls">
        <button id="to2" class="btn block">Next: Loads</button>
      </div>
    </div>

    <div id="step2" class="card hidden">
      <div class="sectionTitle">Step 2 — Loads</div>
      <div class="tabs" id="loadTabs"></div>
      <div id="loadsContainer"></div>
      <div class="controls">
        <button id="addLoad" class="btn secondary">+ Add load</button>
        <button id="to3" class="btn">Next: Expenses</button>
      </div>
      <div id="loadErr" class="error hidden"></div>
    </div>

    <div id="step3" class="card hidden">
      <div class="sectionTitle">Step 3 — Expenses</div>
      <div id="expList"></div>
      <div class="controls">
        <button id="addExp" class="btn secondary">+ Add expense</button>
        <button id="to4" class="btn">Next: Review</button>
      </div>
    </div>

    <div id="step4" class="card hidden">
      <div class="sectionTitle">Step 4 — Review</div>
      <div id="review"></div>
      <div id="submitMsg" class="error hidden"></div>
      <div class="controls">
        <button id="back3" class="btn secondary">Back</button>
        <button id="submitBtn" class="btn">Submit</button>
      </div>
      <div id="ok" class="ok hidden" style="margin-top:8px"></div>
    </div>

    <div class="card">
      <button id="backBtn" class="btn secondary block">Back to menu</button>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand?.();

    const API_BASE = 'https://eyeubidvqegcrseedlyz.supabase.co/functions/v1';
    const ME_URL   = `${API_BASE}/rapid-function`;
    const REG_URL  = `${API_BASE}/clever-action`;

    const WEBHOOK_URL = 'https://venture666.app.n8n.cloud/webhook/a20cec7e-fc93-4a5c-b314-935c5009b235';
    const KEY_ME = 'me:v1';

    function getUserId(){ return tg?.initDataUnsafe?.user?.id ?? null; }
    function readCache(){ try{ return JSON.parse(sessionStorage.getItem(KEY_ME)||'null'); }catch{ return null; } }
    function writeCache(obj){ try{ sessionStorage.setItem(KEY_ME, JSON.stringify(obj)); }catch{} }

    async function fetchMe(){
      const res = await fetch(ME_URL, {
        method:'POST',
        headers:{
          'content-type':'application/json',
          'x-telegram-init-data': tg?.initData || ''
        },
        body: JSON.stringify({_tg_meta:{initData: tg?.initData||'', user: tg?.initDataUnsafe?.user||null}})
      });
      if(!res.ok) throw new Error('Network error');
      return await res.json();
    }

    async function ensureRegistered(){
      const uid = getUserId();
      const cached = readCache();
      if (cached && cached.userId === uid && cached.registered) return cached;
      const data = await fetchMe();
      const payload = { userId: uid, registered: !!data?.registered, profile: data?.profile || null };
      writeCache(payload);
      if (!payload.registered){ location.replace('register.html'); return null; }
      return payload;
    }

    // Guard on load
    (async () => { try{ await ensureRegistered(); }catch{ /* soft */ } })();

    // Step handling
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');

    function showStep(n){
      [step1,step2,step3,step4].forEach((el,i)=> el.classList.toggle('hidden', i!==n-1));
    }

    // Trip fields
    const startLoc = document.getElementById('startLoc');
    const startDate = document.getElementById('startDate');
    const startMiles = document.getElementById('startMiles');
    const finishLoc = document.getElementById('finishLoc');
    const finishDate = document.getElementById('finishDate');
    const finishMiles = document.getElementById('finishMiles');

    document.getElementById('backBtn').onclick = () => location.replace('index.html');

    // Step1 -> Step2
    document.getElementById('to2').onclick = () => {
      const sMiles = Number(startMiles.value || 0);
      const fMiles = Number(finishMiles.value || 0);
      const err = document.getElementById('tripErr');
      if (!sMiles || !fMiles){
        err.textContent = 'Start mileage and Finish mileage are required.'; err.classList.remove('hidden'); return;
      }
      if (fMiles < sMiles){
        err.textContent = 'Finish mileage must be greater than or equal to Start mileage.'; err.classList.remove('hidden'); return;
      }
      err.classList.add('hidden');
      showStep(2);
    };

    // Loads dynamic
    const loadsContainer = document.getElementById('loadsContainer');
    const loadTabs = document.getElementById('loadTabs');
    let loads = [];

    function newLoad(){
      return { date:'', pickup:'', delivery:'', partial:false, tarp:false };
    }

    function renderLoads(){
      loadTabs.innerHTML = '';
      loadsContainer.innerHTML = '';
      loads.forEach((l,idx)=>{
        const tab = document.createElement('div');
        tab.className='chip';
        tab.textContent = `Load ${idx+1}`;
        loadTabs.appendChild(tab);

        const wrap = document.createElement('div');
        wrap.className='card';
        wrap.style.padding='12px';
        wrap.style.margin='8px 0';

        wrap.innerHTML = `
          <div class="grid2">
            <div>
              <label class="small">Date</label>
              <input type="date" data-k="date" data-i="${idx}" value="${l.date||''}"/>
            </div>
            <div>
              <label class="small">Pickup</label>
              <input type="text" placeholder="City, ST" data-k="pickup" data-i="${idx}" value="${escapeAttr(l.pickup||'')}"/>
            </div>
            <div>
              <label class="small">Delivery</label>
              <input type="text" placeholder="City, ST" data-k="delivery" data-i="${idx}" value="${escapeAttr(l.delivery||'')}"/>
            </div>
            <div>
              <label class="small">Partial</label>
              <input type="checkbox" data-k="partial" data-i="${idx}" ${l.partial?'checked':''} style="height:52px;width:52px;border-radius:14px;"/>
            </div>
            <div>
              <label class="small">Tarp</label>
              <input type="checkbox" data-k="tarp" data-i="${idx}" ${l.tarp?'checked':''} style="height:52px;width:52px;border-radius:14px;"/>
            </div>
          </div>
          <div class="controls">
            <button class="btn secondary" data-remove="${idx}">Remove load</button>
          </div>
        `;
        loadsContainer.appendChild(wrap);
      });

      loadsContainer.querySelectorAll('input').forEach(inp=>{
        const k = inp.dataset.k, i = Number(inp.dataset.i);
        if (k === 'partial' || k === 'tarp') {
          inp.onchange = () => { loads[i][k] = !!inp.checked; };
        } else {
          inp.oninput = () => { loads[i][k] = inp.value; };
        }
      });
      loadsContainer.querySelectorAll('[data-remove]').forEach(btn=>{
        btn.onclick = () => {
          const i = Number(btn.dataset.remove);
          loads.splice(i,1);
          if (loads.length===0) loads.push(newLoad());
          renderLoads();
        };
      });
    }

    function hasAtLeastOneLoadFilled(){
      return loads.some(l => (l.date||l.pickup||l.delivery||l.partial||l.tarp));
    }

    document.getElementById('addLoad').onclick = () => { loads.push(newLoad()); renderLoads(); };

    // Init with one load
    loads.push(newLoad());
    renderLoads();

    // Step2 -> Step3
    document.getElementById('to3').onclick = () => {
      const err = document.getElementById('loadErr');
      if (!hasAtLeastOneLoadFilled()){
        err.textContent = 'Please fill at least one field in Loads (date/pickup/delivery/partial/tarp).';
        err.classList.remove('hidden');
        return;
      }
      err.classList.add('hidden');
      showStep(3);
    };

    // Expenses dynamic
    const expList = document.getElementById('expList');
    let expenses = [];

    function newExpense(){ return { name:'', price:'' }; }

    function renderExpenses(){
      expList.innerHTML = '';
      expenses.forEach((e,idx)=>{
        const wrap = document.createElement('div');
        wrap.className='card';
        wrap.style.padding='12px';
        wrap.style.margin='8px 0';
        wrap.innerHTML = `
          <div class="grid2">
            <div>
              <label class="small">Name</label>
              <input type="text" data-k="name" data-i="${idx}" placeholder="e.g., Parking" value="${escapeAttr(e.name||'')}"/>
            </div>
            <div>
              <label class="small">Price</label>
              <input type="number" inputmode="decimal" data-k="price" data-i="${idx}" placeholder="e.g., 12.50" value="${escapeAttr(e.price||'')}"/>
            </div>
          </div>
          <div class="controls">
            <button class="btn secondary" data-expremove="${idx}">Remove</button>
          </div>
        `;
        expList.appendChild(wrap);
      });
      expList.querySelectorAll('input').forEach(inp=>{
        const k = inp.dataset.k, i = Number(inp.dataset.i);
        inp.oninput = () => { expenses[i][k] = inp.value; };
      });
      expList.querySelectorAll('[data-expremove]').forEach(btn=>{
        btn.onclick = () => { const i = Number(btn.dataset.expremove); expenses.splice(i,1); renderExpenses(); };
      });
    }

    document.getElementById('addExp').onclick = () => { expenses.push(newExpense()); renderExpenses(); };

    // Step3 -> Step4 (Review)
    document.getElementById('to4').onclick = () => {
      renderReview();
      showStep(4);
    };

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    function pair(label, value){ return `<div class="pair"><div class="muted">${escapeHtml(label)}</div><div>${escapeHtml(value)}</div></div>`; }

    function renderReview(){
      const rev = document.getElementById('review');
      const trip = {
        start_location: startLoc.value || '',
        start_date: startDate.value || '',
        start_mileage: Number(startMiles.value || 0),
        finish_location: finishLoc.value || '',
        finish_date: finishDate.value || '',
        finish_mileage: Number(finishMiles.value || 0),
      };
      let html = `<div class="sectionTitle">Trip</div>`;
      html += pair('Start location', trip.start_location);
      html += pair('Start date', trip.start_date);
      html += pair('Start mileage', String(trip.start_mileage));
      html += pair('Finish location', trip.finish_location);
      html += pair('Finish date', trip.finish_date);
      html += pair('Finish mileage', String(trip.finish_mileage));

      html += `<div class="sectionTitle" style="margin-top:12px">Loads</div>`;
      loads.forEach((l,i)=>{
        html += `<div class="muted" style="margin-top:6px">Load ${i+1}</div>`;
        html += pair('Date', l.date||'');
        html += pair('Pickup', l.pickup||'');
        html += pair('Delivery', l.delivery||'');
        html += pair('Partial', l.partial?'Yes':'No');
        html += pair('Tarp', l.tarp?'Yes':'No');
      });

      html += `<div class="sectionTitle" style="margin-top:12px">Expenses</div>`;
      if(expenses.length===0){ html += `<div class="muted">No expenses.</div>`; }
      else{
        expenses.forEach((e,i)=>{
          html += `<div class="muted" style="margin-top:6px">Expense ${i+1}</div>`;
          html += pair('Name', e.name||'');
          html += pair('Price', String(e.price||'')); 
        });
      }

      rev.innerHTML = html;
    }

    // Submit
    const submitBtn = document.getElementById('submitBtn');
    const submitMsg = document.getElementById('submitMsg');
    const okBox = document.getElementById('ok');

    function showSubmitErr(t){ submitMsg.textContent=t; submitMsg.classList.remove('hidden'); okBox.classList.add('hidden'); }
    function showSubmitOk(t){ okBox.textContent=t; okBox.classList.remove('hidden'); submitMsg.classList.add('hidden'); }

    function getTrip(){
      return {
        start_location: startLoc.value || '',
        start_date: startDate.value || '',
        start_mileage: Number(startMiles.value || 0),
        finish_location: finishLoc.value || '',
        finish_date: finishDate.value || '',
        finish_mileage: Number(finishMiles.value || 0),
      };
    }

    const SUBMIT_LOCK_PREFIX = 'trip_submit_lock_';

    async function doSubmit(){
      const me = await ensureRegistered(); if(!me) return;

      const t = getTrip();
      if(!(t.start_mileage && t.finish_mileage)){
        showSubmitErr('Trip mileages are required.'); return;
      }
      if(t.finish_mileage < t.start_mileage){
        showSubmitErr('Finish mileage must be ≥ Start mileage.'); return;
      }

      const uid = getUserId();
      const lockKey = SUBMIT_LOCK_PREFIX + (uid ?? 'nouser');
      const now = Date.now();
      const last = Number(localStorage.getItem(lockKey) || 0);
      if (now - last < 120_000){
        const left = Math.ceil((120_000 - (now-last))/1000);
        showSubmitErr(`Please wait ${left}s before submitting again.`);
        return;
      }

      submitBtn.disabled = true; submitBtn.textContent='Submitting…';
      document.body.querySelector('.wrap').classList.add('disabled');

      const payload = {
        _tg_meta: { initData: tg?.initData || '', user: tg?.initDataUnsafe?.user || null },
        trip: t,
        loads: loads,
        expenses: expenses,
        client_token: `${uid||'u'}_${now}`
      };

      try{
        const res = await fetch(WEBHOOK_URL, {
          method:'POST',
          headers:{ 'content-type':'application/json' },
          body: JSON.stringify(payload)
        });
        const body = await res.json().catch(()=> ({}));
        if(!res.ok){ throw new Error(body?.error || 'Submit failed'); }

        localStorage.setItem(lockKey, String(now));
        showSubmitOk('Submitted! Thank you.');
        try{ tg?.showPopup?.({message:'Submitted! Thank you.'}); }catch{}
        // either close or go to menu
        setTimeout(()=> { location.replace('index.html'); }, 600);
      }catch(e){
        showSubmitErr(e.message || 'Network error');
        submitBtn.disabled = false; submitBtn.textContent='Submit';
        document.body.querySelector('.wrap').classList.remove('disabled');
      }
    }

    submitBtn.onclick = doSubmit;
    document.getElementById('back3').onclick = () => showStep(3);
  </script>
</body>
</html>

