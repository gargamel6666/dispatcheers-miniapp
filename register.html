<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver â€¢ Register</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-secondary-bg-color, #0f1220);
      --text: var(--tg-theme-text-color, #e6e6e6);
      --muted: var(--tg-theme-hint-color, #9aa3b2);
      --accent: var(--tg-theme-button-color, #4e8cff);
      --accentText: var(--tg-theme-button-text-color, #fff);
      --card: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --radius: 18px;
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    html, body { height: 100%; }
    body{
      margin:0;
      font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 100% -10%, rgba(78,140,255,0.25), transparent 60%),
        radial-gradient(1000px 500px at -10% 110%, rgba(168,85,247,0.20), transparent 60%),
        var(--bg);
      padding: calc(12px + var(--safe-top)) 16px calc(20px + var(--safe-bottom));
      display:flex; align-items:center; justify-content:center;
    }
    .card{
      width:100%;
      max-width:520px;
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding:20px;
    }
    .head{ display:flex; align-items:center; gap:12px; margin-bottom: 20px; }
    .logo{
      width:38px; height:38px; border-radius:12px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      box-shadow: 0 6px 16px rgba(0,0,0,.25);
      flex:0 0 38px;
    }
    h1{ font-size:18px; line-height:1.25; margin:0; }
    .sub{ color:var(--muted); font-size:13px; margin-top:4px; }

    /* --- NEW INPUT TILE STYLES --- */
    .input-tile {
        /* Mimic the tile in index.html */
        border: 1px solid var(--stroke);
        border-radius: 16px;
        padding: 16px;
        background: rgba(255,255,255,0.05);
        box-shadow: 0 6px 16px rgba(0,0,0,.15);
        transition: box-shadow .12s ease, transform .12s ease;
    }
    .input-tile:focus-within {
        /* Glow effect on focus */
        box-shadow: 0 0 0 2px var(--accent), 0 6px 16px rgba(0,0,0,.15);
        transform: translateY(-1px); /* Slight lift on focus */
    }

    label{
      /* Label is now part of the tile structure */
      display:flex; align-items:center; gap:8px;
      font-weight:700; font-size:14px; margin:0 0 8px 0;
      color:var(--text);
    }
    .tile-icon {
        font-size: 18px; /* Icon size */
        line-height: 1;
    }

    /* Actual input field, now transparent and borderless inside the tile */
    .text-input{
      width:100%; height:auto; border-radius:0;
      border:none;
      background:transparent;
      color:var(--text);
      padding:0; outline:none;
      font-size:16px;
    }
    .text-input::placeholder { color: var(--muted); opacity: 0.7; }
    /* --- END NEW INPUT TILE STYLES --- */


    .row{ display:flex; gap:10px; margin-top: 20px; }
    .btn{
      flex:1; padding:14px 16px; border-radius:14px; border:0;
      background:var(--accent); color:var(--accentText); font-weight:800;
      cursor:pointer; transition: transform .12s ease;
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0); }
    .btn.secondary{
      background:transparent; color:var(--text);
      border:1px solid var(--stroke); font-weight:700;
    }
    .btn[disabled]{ opacity:.6; pointer-events:none; }

    .msg{ font-size:13px; margin-top:8px; display:none; }
    .msg.error{ color:#ff6b6b; }
    .msg.ok{ color:#2ecc71; }

    .hint{ color:var(--muted); font-size:13px; margin-top:8px; }

    .extra-row {
        margin-top: 10px;
    }
    .extra-row .btn.secondary {
        width: 100%; /* Make the support button full width */
        flex: auto;
    }
  </style>
</head>
<body>
  <main class="card">
    <div class="head">
      <div class="logo"></div>
      <div>
        <h1>Quick Registration</h1>
        <div class="sub">Weâ€™ll link your Telegram to your driver profile.</div>
      </div>
    </div>

    <section class="input-tile">
        <label for="fullName">
            <span class="tile-icon">ðŸ‘¤</span>Full name
        </label>
        <input
            id="fullName"
            class="text-input"
            type="text"
            inputmode="text"
            autocomplete="off"
            placeholder="e.g., John Smith"
        />
    </section>
    <div id="msg" class="msg"></div>

    <div class="row">
      <button id="backBtn" class="btn secondary" type="button">Back</button>
      <button id="goBtn" class="btn" type="button">Continue</button>
    </div>

    <div class="extra-row">
        <button id="supportBtn" class="btn secondary" type="button">Support</button>
    </div>

    <div id="hint" class="hint"></div>
  </main>

  <script>
    // --- Telegram init
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand?.();

    // --- API endpoints (unchanged)
    const API_BASE = 'https://eyeubidvqegcrseedlyz.supabase.co/functions/v1';
    const ME_URL   = `${API_BASE}/rapid-function`;
    const REG_URL  = `${API_BASE}/clever-action`;

    // --- Keys / locks (unchanged)
    const KEY_ME = 'me:v1';
    const LOCK_PREFIX = 'register_lock_';

    function getUserId(){ return tg?.initDataUnsafe?.user?.id ?? null; }
    function writeCache(obj){ try{ sessionStorage.setItem(KEY_ME, JSON.stringify(obj)); }catch{} }

    const msgEl = document.getElementById('msg');
    function showError(t){ msgEl.textContent=t; msgEl.className='msg error'; msgEl.style.display='block'; }
    function showOk(t){ msgEl.textContent=t; msgEl.className='msg ok'; msgEl.style.display='block'; }

    // Back to menu
    document.getElementById('backBtn').onclick = () => location.replace('index.html');

    // Support button logic
    document.getElementById('supportBtn').onclick = () => location.replace('support.html');

    let inFlight = false;

    async function doRegister(){
      if(inFlight) return;

      const fullName = (document.getElementById('fullName').value || '').trim();
      if(!fullName){ showError('Please enter your full name.'); return; }

      const uid = getUserId();
      const lockKey = LOCK_PREFIX + (uid ?? 'nouser');
      const now = Date.now();
      const last = Number(localStorage.getItem(lockKey) || 0);
      if (now - last < 60_000){
        const left = Math.ceil((60_000 - (now-last))/1000);
        showError(`Try again in ${left}s.`);
        return;
      }

      inFlight = true;
      localStorage.setItem(lockKey, String(now));
      const btn = document.getElementById('goBtn');
      const hint = document.getElementById('hint');
      btn.disabled = true; btn.textContent = 'Registeringâ€¦'; hint.textContent = '';

      try{
        const res = await fetch(REG_URL, {
          method:'POST',
          headers:{
            'content-type':'application/json',
            'x-telegram-init-data': tg?.initData || ''
          },
          body: JSON.stringify({
            full_name: fullName,
            _tg_meta:{ initData: tg?.initData||'', user: tg?.initDataUnsafe?.user||null }
          })
        });

        const body = await res.json().catch(()=>({}));
        if(!res.ok){ throw new Error(body?.error || 'Network error'); }

        writeCache({ userId: uid, registered:true, profile: { full_name: fullName } });
        showOk('Registered!');
        location.replace('index.html');
      }catch(e){
        showError(String(e.message||e));
        btn.disabled = false; btn.textContent = 'Continue';
        inFlight = false;
      }
    }

    document.getElementById('goBtn').onclick = doRegister;

    // Submit on Enter
    document.getElementById('fullName').addEventListener('keydown', (e)=>{
      if(e.key === 'Enter'){ e.preventDefault(); doRegister(); }
    });
  </script>
</body>
</html>
