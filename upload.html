<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Driver • Upload BOL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: var(--tg-theme-secondary-bg-color, #0f1220);
      --text: var(--tg-theme-text-color, #e6e6e6);
      --muted: var(--tg-theme-hint-color, #9aa3b2);
      --accent: var(--tg-theme-button-color, #4e8cff);
      --accentText: var(--tg-theme-button-text-color, #fff);
      --card: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.12);
      --radius: 18px;
      --shadow: 0 10px 30px rgba(0,0,0,0.25);
      --safe-top: env(safe-area-inset-top, 0px);
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;background:radial-gradient(1200px 800px at 20% -10%, rgba(78,140,255,0.15), transparent 60%), radial-gradient(1000px 700px at 120% 110%, rgba(78,140,255,0.12), transparent 60%), var(--bg); color:var(--text); font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Helvetica Neue',Arial}
    .wrap{min-height:100svh; padding:calc(12px + var(--safe-top)) 16px calc(20px + var(--safe-bottom)); display:flex; flex-direction:column; gap:16px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); backdrop-filter: blur(10px); padding:16px}
    .head{display:flex; gap:12px; align-items:center}
    .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7aa5ff); box-shadow:0 6px 16px rgba(0,0,0,.25)}
    h1{font-size:18px;margin:0 0 4px 0}
    .muted{color:var(--muted); font-size:13px}
    input[type="file"]{width:100%; border:1px solid var(--stroke); background:rgba(255,255,255,0.04); border-radius:14px; padding:12px}
    .row{display:flex; gap:10px}
    .btn{flex:1; padding:14px 16px; text-align:center; border-radius:14px; border:0; background:var(--accent); color:var(--accentText); font-weight:700; cursor:pointer}
    .btn.secondary{background:transparent; color:var(--text); border:1px solid var(--stroke)}
    .btn[disabled]{opacity:.6; pointer-events:none}
    .error{color:#ff6b6b; font-size:13px; margin-top:8px}
    .ok{color:#2ecc71; font-size:13px; margin-top:8px}
    .hidden{display:none}
    .disabled{opacity:0.6; pointer-events:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="head">
        <div class="logo"></div>
        <div>
          <h1>Upload BOL</h1>
          <div class="muted">Attach your BOL file(s). We’ll capture your Telegram user ID automatically.</div>
        </div>
      </div>
      <input id="fileInput" type="file" accept=".pdf,.jpg,.jpeg,.png" multiple />
      <div id="alert" class="error hidden"></div>
      <div id="ok" class="ok hidden"></div>
    </div>

    <div class="card">
      <div class="row">
        <button id="backBtn" class="btn secondary">Back</button>
        <button id="sendBtn" class="btn">Submit</button>
      </div>
    </div>
  </div>

  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = window.Telegram?.WebApp; tg?.ready(); tg?.expand?.();

    const API_BASE = 'https://eyeubidvqegcrseedlyz.supabase.co/functions/v1';
    const ME_URL   = `${API_BASE}/rapid-function`;
    const REG_URL  = `${API_BASE}/clever-action`;

    const WEBHOOK_URL = 'https://venture666.app.n8n.cloud/webhook/upload-bol';
    const KEY_ME = 'me:v1';

    function getUserId(){ return tg?.initDataUnsafe?.user?.id ?? null; }
    function readCache(){ try{ return JSON.parse(sessionStorage.getItem(KEY_ME)||'null'); }catch{ return null; } }
    function writeCache(obj){ try{ sessionStorage.setItem(KEY_ME, JSON.stringify(obj)); }catch{} }

    async function fetchMe(){
      const res = await fetch(ME_URL, {
        method:'POST',
        headers:{
          'content-type':'application/json',
          'x-telegram-init-data': tg?.initData || ''
        },
        body: JSON.stringify({_tg_meta:{initData: tg?.initData||'', user: tg?.initDataUnsafe?.user||null}})
      });
      if(!res.ok) throw new Error('Network error');
      return await res.json();
    }

    async function ensureRegistered(){
      const uid = getUserId();
      const cached = readCache();
      if (cached && cached.userId === uid && cached.registered) return cached;
      const data = await fetchMe();
      const payload = { userId: uid, registered: !!data?.registered, profile: data?.profile || null };
      writeCache(payload);
      if (!payload.registered){ location.replace('register.html'); return null; }
      return payload;
    }

    (async () => {
      try{ await ensureRegistered(); }catch{ /* soft fail; guard below on send */ }
    })();

    const alertBox = document.getElementById('alert');
    const okBox = document.getElementById('ok');
    const fileInput = document.getElementById('fileInput');
    const sendBtn = document.getElementById('sendBtn');
    const backBtn = document.getElementById('backBtn');

    backBtn.onclick = () => location.replace('index.html');

    function showErr(t){ alertBox.textContent=t; alertBox.classList.remove('hidden'); okBox.classList.add('hidden'); }
    function showOk(t){ okBox.textContent=t; okBox.classList.remove('hidden'); alertBox.classList.add('hidden'); }

    async function submitFiles(){
      const me = await ensureRegistered(); if(!me) return;
      const files = fileInput.files;
      if(!files || files.length===0){ showErr('Please select at least one file.'); return; }

      const container = document.body.querySelector('.wrap');
      container.classList.add('disabled');
      sendBtn.disabled = true; sendBtn.textContent='Uploading…';

      try{
        const fd = new FormData();
        for (const f of files) fd.append('files', f, f.name);
        const total = [...files].reduce((s,f)=>s+f.size,0);
        fd.append('_tg_meta', JSON.stringify({ initData: tg?.initData || '', user: tg?.initDataUnsafe?.user || null }));
        fd.append('_debug_file_count', String(files.length));
        fd.append('_debug_total_bytes', String(total));

        const res = await fetch(WEBHOOK_URL, { method:'POST', body: fd });
        if(!res.ok) throw new Error('Upload failed');

        showOk('Thanks! Your BOL has been submitted.');
        document.querySelector('.row').innerHTML = `<button class="btn secondary" id="menuBtn">Back to menu</button>`;
        document.getElementById('menuBtn').onclick = () => location.replace('index.html');
      }catch(e){
        showErr(e.message || 'Network error');
        container.classList.remove('disabled');
        sendBtn.disabled = false; sendBtn.textContent='Submit';
      }
    }

    sendBtn.onclick = submitFiles;
  </script>
</body>
</html>

