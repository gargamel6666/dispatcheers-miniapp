<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Support</title>

  <style>
    :root {
      --bg-main: #0f172a;
      --card-bg: rgba(30, 41, 59, .8);
      --card-border: rgba(255,255,255,.07);
      --text-primary: #fff;
      --text-dim: #94a3b8;
      --text-mid: #cbd5e1;
      --stroke-focus: #38bdf8;
      --button-bg: #2563eb;
      --button-bg-disabled: #475569;
      --button-text-disabled: #9ca3af;
      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 12px;
      --padding-page: 16px;
      --padding-card: 16px;
      --font-stack: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      padding: var(--padding-page);
      background-color: var(--bg-main);
      color: var(--text-primary);
      font-family: var(--font-stack);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    /* header card */
    .headerCard {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      padding: var(--padding-card);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .titleRow {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      row-gap: 8px;
    }

    .pageTitle {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .userInfo {
      text-align: right;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-dim);
      white-space: pre-line;
    }

    .hint {
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-dim);
    }

    /* main card (form) */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      padding: var(--padding-card);
      display: flex;
      flex-direction: column;
    }

    .fieldGroup {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .fieldLabel {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-mid);
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(15,23,42,0.6);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.4;
      padding: 12px;
      outline: none;
      resize: none;
    }

    textarea:focus {
      border-color: var(--stroke-focus);
      box-shadow: 0 0 0 2px rgba(56,189,248,.3);
    }

    .buttonPrimary {
      appearance: none;
      width: 100%;
      border: 0;
      border-radius: var(--radius-md);
      background: var(--button-bg);
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      line-height: 1.2;
      padding: 14px 16px;
      text-align: center;
    }

    .buttonPrimary[disabled] {
      background: var(--button-bg-disabled);
      color: var(--button-text-disabled);
    }

    .statusMsg {
      min-height: 1.2em;
      text-align: center;
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-dim);
      margin-top: 12px;
      word-break: break-word;
    }

    .footNote {
      text-align: center;
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-dim);
      max-width: 480px;
      margin: 24px auto 0;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- top card: title + user -->
    <section class="headerCard">
      <div class="titleRow">
        <div class="pageTitle">
          Support request
        </div>
        <div class="userInfo" id="userInfo">
          User: —
        </div>
      </div>
      <div class="hint">
        Tell us what’s wrong (upload issue, can't open, payment question, etc.).
      </div>
    </section>

    <!-- main card: form -->
    <section class="card">
      <div class="fieldGroup">
        <label class="fieldLabel" for="problemField">
          Describe the problem
        </label>
        <textarea
          id="problemField"
          placeholder="Example:
Can't upload document.
App shows 'error'.
Started today around 2 PM."
        ></textarea>
      </div>

      <button id="sendBtn" class="buttonPrimary">
        Send
      </button>

      <div class="statusMsg" id="statusMsg"></div>
    </section>
  </div>

  <div class="footNote" id="footNote">
    We'll review and follow up.
  </div>

  <script>
  // Telegram WebApp context
  const tg = window.Telegram && window.Telegram.WebApp
    ? window.Telegram.WebApp
    : null;

  if (tg && tg.expand) {
    tg.expand();
  }

  // Extract Telegram user info (neutral, role-agnostic)
  const tgUser = tg?.initDataUnsafe?.user || {};
  const telegramUserId = tgUser.id || null;
  const telegramFirst  = tgUser.first_name || '';
  const telegramLast   = tgUser.last_name || '';
  const telegramName = [telegramFirst, telegramLast]
    .filter(Boolean)
    .join(' ')
    .trim() || 'User';

  // Fill header with simple user info
  const userInfoEl = document.getElementById('userInfo');
  userInfoEl.textContent = telegramUserId
    ? `${telegramName}\nID: ${telegramUserId}`
    : telegramName;

  // Elements
  const problemField = document.getElementById('problemField');
  const sendBtn      = document.getElementById('sendBtn');
  const statusMsg    = document.getElementById('statusMsg');

  async function sendSupportTicket() {
    const message = problemField.value.trim();

    if (!message) {
      statusMsg.style.color = "#f87171"; // red-400
      statusMsg.textContent = "Please describe the problem.";
      return;
    }

    // lock UI to prevent spam
    sendBtn.disabled = true;
    problemField.disabled = true;
    statusMsg.style.color = "#94a3b8"; // slate-400
    statusMsg.textContent = "Sending...";

    try {
      // IMPORTANT: replace this with your real webhook URL
      const resp = await fetch("https://SUPPORT_WEBHOOK_URL", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          telegram_user_id: telegramUserId,
          telegram_name: telegramName,
          message,
          ts_client: new Date().toISOString()
        })
      });

      if (!resp.ok) {
        throw new Error("Request failed");
      }

      // success visual
      statusMsg.style.color = "#4ade80"; // green-400
      statusMsg.textContent = "✅ Sent. We'll review shortly.";

      // small delay then close mini app
      setTimeout(() => {
        if (tg && tg.close) {
          tg.close(); // this closes the WebApp and returns user to chat
        }
      }, 1500);

    } catch (err) {
      // unlock so they can retry
      sendBtn.disabled = false;
      problemField.disabled = false;

      statusMsg.style.color = "#f87171"; // red-400
      statusMsg.textContent = "Error sending. Try again.";
    }
  }

  sendBtn.addEventListener('click', sendSupportTicket);
</script>
</body>
</html>
