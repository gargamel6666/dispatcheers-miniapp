<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>Support</title>

  <style>
    :root {
      --bg-main: #0f172a;
      --card-bg: rgba(30, 41, 59, .8);
      --card-border: rgba(255,255,255,.07);
      --text-primary: #fff;
      --text-dim: #94a3b8;
      --text-mid: #cbd5e1;
      --stroke-focus: #38bdf8;
      --button-bg: #2563eb;
      --button-bg-disabled: #475569;
      --button-text-disabled: #9ca3af;
      --radius-xl: 20px;
      --radius-lg: 14px;
      --radius-md: 12px;
      --padding-page: 16px;
      --padding-card: 16px;
      --font-stack: system-ui, -apple-system, BlinkMacSystemFont, "Inter",
        Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      padding: var(--padding-page);
      background-color: var(--bg-main);
      color: var(--text-primary);
      font-family: var(--font-stack);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      position: relative;
    }

    .wrapper {
      width: 100%;
      max-width: 480px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 1;
      position: relative;
    }

    .headerCard {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      padding: var(--padding-card);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .titleRow {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      flex-wrap: wrap;
      row-gap: 8px;
    }

    .pageTitle {
      font-size: 18px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .userInfo {
      text-align: right;
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-dim);
      white-space: pre-line;
    }

    .hint {
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-dim);
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius-xl);
      padding: var(--padding-card);
      display: flex;
      flex-direction: column;
    }

    .fieldGroup {
      display: flex;
      flex-direction: column;
      margin-bottom: 16px;
    }

    .fieldLabel {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-mid);
      margin-bottom: 8px;
    }

    textarea {
      width: 100%;
      min-height: 140px;
      border-radius: var(--radius-lg);
      border: 1px solid rgba(255,255,255,0.1);
      background: rgba(15,23,42,0.6);
      color: var(--text-primary);
      font-size: 15px;
      line-height: 1.4;
      padding: 12px;
      outline: none;
      resize: none;
    }

    textarea:focus {
      border-color: var(--stroke-focus);
      box-shadow: 0 0 0 2px rgba(56,189,248,.3);
    }

    .buttonPrimary {
      appearance: none;
      width: 100%;
      border: 0;
      border-radius: var(--radius-md);
      background: var(--button-bg);
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
      line-height: 1.2;
      padding: 14px 16px;
      text-align: center;
    }

    .buttonPrimary[disabled] {
      background: var(--button-bg-disabled);
      color: var(--button-text-disabled);
    }

    .statusMsg {
      min-height: 1.2em;
      text-align: center;
      font-size: 14px;
      line-height: 1.4;
      color: var(--text-dim);
      margin-top: 12px;
      word-break: break-word;
      min-height: 20px;
    }

    .footNote {
      text-align: center;
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-dim);
      max-width: 480px;
      margin: 24px auto 0;
    }

    /* full-screen overlay after submit */
    .finalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.95);
      display: none; /* turned on after send */
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 24px;
    }

    .finalCard {
      background: rgba(30, 41, 59, 0.9);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      max-width: 360px;
      width: 100%;
      padding: 24px 20px;
      text-align: center;
      box-shadow: 0 30px 120px rgba(0,0,0,0.8);
    }

    .finalIcon {
      font-size: 32px;
      line-height: 1;
      color: #4ade80; /* green-400 */
      margin-bottom: 12px;
    }

    .finalTitle {
      color: #fff;
      font-size: 18px;
      font-weight: 600;
      line-height: 1.3;
      margin-bottom: 8px;
    }

    .finalText {
      font-size: 14px;
      line-height: 1.4;
      color: #94a3b8;
      white-space: pre-line;
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- top card: title + user -->
    <section class="headerCard">
      <div class="titleRow">
        <div class="pageTitle">
          Support request
        </div>
        <div class="userInfo" id="userInfo">User: —</div>
      </div>
      <div class="hint">
        Tell us what’s wrong (upload issue, can't open, payment question, etc.).
      </div>
    </section>

    <!-- main card: form -->
    <section class="card">
      <div class="fieldGroup">
        <label class="fieldLabel" for="problemField">
          Describe the problem
        </label>
        <textarea
          id="problemField"
          placeholder="Example:
Can't upload document.
App shows 'error'.
Started today around 2 PM."
        ></textarea>
      </div>

      <button id="sendBtn" class="buttonPrimary">
        Send
      </button>

      <div class="statusMsg" id="statusMsg"></div>
    </section>
  </div>

  <div class="footNote">
    We'll review and follow up.
  </div>

  <!-- overlay after submit -->
  <div class="finalOverlay" id="finalOverlay">
    <div class="finalCard">
      <div class="finalIcon">✅</div>
      <div class="finalTitle">Sent</div>
      <div class="finalText">
        We'll review shortly.
        
        You can close this window now.
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    var SUPPORT_WEBHOOK_URL = "https://venture666.app.n8n.cloud/webhook/b981b421-cce9-450f-8006-13aa7916b416";

    // ===== TELEGRAM CONTEXT =====
    var tg = null;
    if (window.Telegram && window.Telegram.WebApp) {
      tg = window.Telegram.WebApp;
    }

    if (tg && typeof tg.expand === "function") {
      tg.expand(); // ask Telegram for full height
    }

    // try to read Telegram user
    var tgUser = {};
    if (tg && tg.initDataUnsafe && tg.initDataUnsafe.user) {
      tgUser = tg.initDataUnsafe.user;
    }

    var telegramUserId  = tgUser.id || null;
    var telegramFirst   = tgUser.first_name || "";
    var telegramLast    = tgUser.last_name || "";
    var telegramNameRaw = (telegramFirst + " " + telegramLast).trim();
    var telegramName    = telegramNameRaw || "User";

    // fill header info
    var userInfoEl = document.getElementById("userInfo");
    if (telegramUserId) {
      userInfoEl.textContent = telegramName + "\nID: " + telegramUserId;
    } else {
      userInfoEl.textContent = telegramName;
    }

    // DOM refs
    var problemField = document.getElementById("problemField");
    var sendBtn      = document.getElementById("sendBtn");
    var statusMsg    = document.getElementById("statusMsg");
    var finalOverlay = document.getElementById("finalOverlay");

    function lockUI() {
      sendBtn.disabled = true;
      problemField.disabled = true;
    }

    function unlockUI() {
      sendBtn.disabled = false;
      problemField.disabled = false;
    }

    function setStatus(color, text) {
      statusMsg.style.color = color;
      statusMsg.textContent = text;
    }

    function showOverlayAndTryClose() {
      // show fullscreen thank-you
      finalOverlay.style.display = "flex";

      // try closing Telegram webapp after a short delay
      setTimeout(function () {
        tryClose();
      }, 800);
    }

    function tryClose() {
      // main documented close()
      if (tg && typeof tg.close === "function") {
        try {
          tg.close();
          return;
        } catch (e) {
          // ignore
        }
      }

      // fallback attempt: some clients expose MainButton.close()
      if (tg && tg.MainButton && typeof tg.MainButton.close === "function") {
        try {
          tg.MainButton.close();
          return;
        } catch (e2) {
          // ignore
        }
      }

      // if neither worked, we just leave the overlay up
      // user will tap X / swipe down manually to dismiss WebApp
    }

    async function sendSupportTicket() {
      var msg = problemField.value.trim();

      if (!msg) {
        setStatus("#f87171", "Please describe the problem.");
        return;
      }

      lockUI();
      setStatus("#94a3b8", "Sending...");

      var payload = {
        telegram_user_id: telegramUserId,
        telegram_name: telegramName,
        message: msg,
        ts_client: new Date().toISOString()
      };

      try {
        var resp = await fetch(SUPPORT_WEBHOOK_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify(payload)
        });

        if (!resp.ok) {
          throw new Error("Request failed with status " + resp.status);
        }

        // success UI
        setStatus("#4ade80", "Sent.");
        showOverlayAndTryClose();

      } catch (err) {
        unlockUI();
        setStatus("#f87171", "Error sending. Try again.");
      }
    }

    sendBtn.addEventListener("click", sendSupportTicket);
  </script>
</body>
</html>
